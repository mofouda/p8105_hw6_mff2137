---
title: "Homework 6"
author: "Mohammad Fouda"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


## Problem 2

### Data cleaning and tidying

```{r}
homicide <-
  read_csv("data/homicide-data.csv") %>% 
  mutate(
      city_state = str_c(city, ", ", state),
      case = ifelse(disposition == "Closed by arrest", 1, 0),
      victim_age = as.numeric(victim_age),
      victim_race = fct_relevel(victim_race, "White", "Black"))%>% 
    filter(
        !(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),
        victim_race %in% c("White", "Black"))
```

### Regression for Baltimore, MD

## Plotting missing vs observed values

```{r}
missing_plot <-
    homicide %>% 
    Amelia::missmap()
```

### Fitting the model 

```{r}
balt_df <-
    homicide %>% 
    filter(city_state == "Baltimore, MD") 

balt_model <-
    balt_df %>% 
    glm(case ~ victim_age + victim_sex + victim_race, family = binomial, data = .) %>% 
    broom::tidy()

balt_or <- 
    glm(case ~ victim_age + victim_sex + victim_race, family = binomial, data = balt_df) %>% 
    epiDisplay::logistic.display(simplified = TRUE) %>% 
    knitr::kable(digits = 2)

balt_or
```

The odds ratio of for solving homicides comparing male victims to female victims keeping all other variables fixed in Baltimore, MD is 0.43 and the 95% confidence interval is 0.32 and 0.56. 


## Regression across all cities

```{r}
all_cities_model <-
    homicide %>% 
    nest(df = -city_state) %>% 
    mutate(
        models = map(.x = df, ~glm(case ~ victim_age + victim_sex + victim_race, family = binomial, data = .x)),
        results = map(models, broom::tidy)) %>% 
    select(city_state, results) %>% 
    unnest(results) %>% 
    filter(term == "victim_sexMale") %>% 
    mutate(
        or = exp(estimate),
        lower95ci = exp(estimate - 1.96*std.error),
        upper95ci = exp(estimate + 1.96*std.error),
        city_state = fct_reorder(city_state, or)) %>% 
    select(city_state, or, lower95ci, upper95ci) 

all_cities_model
```

### Plotting ORs and CI

```{r}
model_plot <-
    all_cities_model %>% 
    ggplot(aes(x = city_state, y = or)) +
    geom_point() +
    geom_errorbar(aes(ymin = lower95ci, ymax = upper95ci), width = 0.2) +
      labs(
        title = "Homicides Esimates Across US Cities",
        x = "City",
        y = "Odds Ratio") + 
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    scale_y_continuous(breaks = seq(0, 5, by = 0.5))
    

model_plot
```

The plot shows that the odds of solving a homicide case of male victims are lower compared to that of a female victim across most US cities with the exception of Fresno, CA, stockton, CA, and Alberqueque, NM. The odds are approximately similar in the cities of Minneapolis, MN, Oklahoma City, OK, Tulsa, OK, Atlanta, GA, and Richmond, VA. 
